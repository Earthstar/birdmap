 <!DOCTYPE html>

<html>
<!-- TEAM MANGO -->
<head>
  <script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
  <!-- Adds deprecated functions so we can use overlay -->
  <script src="http://code.jquery.com/jquery-migrate-1.2.1.js"></script>
  <script type="text/javascript"
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyChibrTeOY3gx8Kg4xQgpj1PnCWFmw10W8&sensor=false">
    </script>
  <script type="text/javascript" src="js/bootstrap.min.js"></script>
  <script type="text/javascript" src="js/jquery-ui-1.10.0.custom.min.js"></script>
  <script type="text/javascript" src="js/jquery.tools.min.js"></script>
  <script type="text/javascript" src="js/handlebars-v1.3.0.js"></script>
  <script type="text/javascript" src="js/bootstrap-timepicker.min.js"></script>
  <script type="application/json" src="birdnames.json"></script>
  <script type="text/javascript" src="js/utilities.js"></script>
  <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
  <link type="text/css" href="css/ui-lightness/jquery-ui-1.10.0.custom.css" rel="stylesheet" />
  <link rel="stylesheet" href="css/bootstrap-timepicker.min.css">
  <link rel="stylesheet" type="text/css" href="css/custom.css">
  <style type="text/css">
  /** FIX for Bootstrap and Google Maps Info window styles problem **/
  img[src*="gstatic.com/"], img[src*="googleapis.com/"] {
    max-width: none;
  }
  </style>
  <title>birdOcular: What birds are around you?</title>
  <script type="text/javascript">
  // Global variables to access anywhere
  var map;
  var birdSightings;
  // There is one global infowindow, initialized in Display.init
  var infoWindow;
  var currentBirdSightings=[]; //all current birds
  var currentFilters=[]; //list of current filters, as objects containing all necessary parameters
  var markers=[];
  var birdsOnMap=[];
  var username = "";
  var newSighting = {
    commonName: "Northern Cardinal",
    speciesName: "Cardinalis cardinalis",
    userSpotted: "cool_bird1337",
    date: new Date(Date.parse("2014-04-15T10:53:00")),
    comment: "This bird is really red",
    position: new google.maps.LatLng(42.3600410, -71.0871950),
      image: "",
      attribution: ""
    }
  $(function() {
    function initialize() {
      // Create a map
      var center = new google.maps.LatLng(42.0, -70.5);
      var mapOptions = {
        center: center,
        zoom: 8
      };
      map = new google.maps.Map(document.getElementById('map-canvas'),
          mapOptions);
    }
    google.maps.event.addDomListener(window, 'load', initialize);


    //Hide autocomplete and filtered windows if empty
    //$( "#autocomplete-answers" ).hide();
    //$( "#filtered-div" ).hide();


    //AUTOCOMPLETE

    var combinedList = [];
    var tags = [];
    var userList = ["zee01","aaron97","fishy","marble","bebop","bay67","boxius_beer45","cardinalis_fan","cool_bird00","cool_bird01","diamond","encephalitis_bastard","eien","finnix","garr","garrrr","haymarket88","house_sparrow_freak","instagramboy","jay_fan","jungle_girl","lazy_dog","mama77","mary","northern_explorer","northern_jay_fan37","oklahoma_lover","passer_ross","rabbit55","southern_grandma","taylor","tilly_taylor","uber_sucks","vietnam_war","wisconsin_rocks","woohoo49","x-ray76","yyyjay","zebra","atlantis78","richard","peter","christoph","daisy","dangitdang","elsevier","fax_machine","not_happy","betty69"];




    $( "#input_bar" ).keyup(function(){
        //$(this).val();
        if (document.getElementById('input_bar').value=='') {
            //$( "#autocomplete-answers" ).hide();
        } else {
            $( "#autocomplete-answers" ).show();
        }
        $( ".autocomplete-removable" ).remove();
        combinedList = userList.concat(birdsOnMap);
        tags = combinedList.sort(function (a, b) {
            return a.toLowerCase().localeCompare(b.toLowerCase());
        });

    });

    $( "#input_bar" ).focus(function() {
       //$( "#autocomplete-answers" ).show();
    });

    $( "#input_bar" ).focusout(function() {
       if (!($("#autocomplete-answers").is(":hover"))) {
           $( "#autocomplete-answers" ).hide();
           $( ".autocomplete-removable" ).remove();
           document.getElementById('input_bar').value='';
        }
    });

    $( "#autocomplete-answers" ).focusout(function() {
       if (!($("#input_bar").is(":hover"))) {
          // $( "#autocomplete-answers" ).hide();
           //$( ".autocomplete-removable" ).remove();
           //document.getElementById('input_bar').value='';
        }
    });

    // This causes a bug

    // $( "html" ).click(function() {
    //    if ((!($("#input_bar").is(":hover")))&&(!($("#autocomplete_answers").is(":hover")))) {
    //        $( "#autocomplete-answers" ).hide();
    //        $( ".autocomplete-removable" ).remove();
    //        document.getElementById('input_bar').value='';
    //     }
    // });

    $( "#input_bar" ).autocomplete({
	source: function( request, response ) {
    var matcher = new RegExp( "^" + $.ui.autocomplete.escapeRegex( request.term ), "i" );
	    response( $.grep( combinedList, function( item ){
        var matches = matcher.test( item );
        if (matches) {
          fillAutoComplete(item);
        }
		  return false;
	    })
      );
  	 }
    });

    // If hit enter in search bar, clears search bar.
    // Maybe not desired behavior?
    // $("#input_bar").keydown(function(e) {
    //   if (e.which === 13) {
    //     $("#input_bar").val("");
    //   }
    // })
    /*$( "#input_bar" ).autocomplete( "option", "minLength", 1 );
    $( "#input-bar" ).autocomplete({
        source: birdsOnMap,
        messages: {
            noResults: '',
            results: function() {}
        }
    });*/

      function refreshPins(){
          if (currentFilters.length<1){
              //no filters, show all birds
              clearFilters();
              return;
          }
          currentBirdSightings=[];
          for(var i=0;i<currentFilters.length; i++){ //add up all the filters
              currentBirdSightings=Filter.or(currentBirdSightings,
                                             Filter.bySpecies(birdSightings,currentFilters[i].replace('-',' ')));
          }
          console.log(currentBirdSightings);
          clearMarkers();
          Display.birdSightings(currentBirdSightings);
      }

      //removes element when user presses the x
      function removeFilter(e){
          var currentID=$(e.currentTarget).attr('id');
          console.log($('#'+currentID)[0]);
          $('#entire-list #'+currentID).prop('checked',false);
          $('#autocomplete-answers #'+currentID).prop('checked',false);
          $(e.currentTarget.parentElement.parentElement).remove();
            var index=currentFilters.indexOf(currentID);
            if (index!=-1){      currentFilters.splice(index,1); } //if it's in the list, get rid of it
          refreshPins();
      }

   //TIME FILTER
      $('#time-select').on('change',function(e){
          //pretend "today" is 2/28/2014 (last date we have data for)
          var startDate=new Date(2014,2,1,0,0,0);
          var endDate=new Date(2014,2,1,0,0,0);
          var interval=$(e.currentTarget).val();
          if (interval=="today"){
              startDate.setDate(startDate.getDate()-1);
          }else if (interval=="week"){
              startDate.setDate(startDate.getDate()-7);
          }else if (interval=="month"){
              startDate.setDate(startDate.getDate()-30);
          }else { //show all
              startDate=new Date(0,0,0,0,0,0);
              endDate=new Date();
          }
              clearMarkers();
              currentBirdSightings=Filter.or(currentBirdSightings,
                                             Filter.byDate(birdSightings,startDate,endDate));
          Display.birdSightings(currentBirdSightings);
      });

      //BIRD FILTER
      $('.filter-list-check input').on('change',filterBirdListener);

      function filterBirdListener(e){
          console.log("click");
          var currentBird=$(e.currentTarget).data('name');
          var currentID=$(e.currentTarget).attr('id');
          var isChecked=$(e.currentTarget).prop('checked');
          if(isChecked){
              if (currentFilters.indexOf(currentID)==-1) {currentFilters.push(currentID);}
              clearMarkers();
              currentBirdSightings=Filter.or(currentBirdSightings,
                                             Filter.bySpecies(birdSightings,currentBird));
              Display.birdSightings(currentBirdSightings);
              var list=$(e.currentTarget.parentElement.parentElement.parentElement);
              if (list.attr('id')!='filters' && $('#filter-list #filters #'+currentID).length==0){
                  addBirdsToFilterDisplay(currentBird);
              }
              $('#'+currentID).prop('checked',true);
              $('#entire-list #'+currentID).prop('checked',true);
              $('#autocomplete-answers #'+currentID).prop('checked',true);
              $('#filters #'+currentID).prop('checked',true);
            }else{
                var index=currentFilters.indexOf(currentID);
                if (index!=-1){      currentFilters.splice(index,1); } //if it's in the list, get rid of it
              refreshPins();
              $('#'+currentID).prop('checked',false);
              $('#entire-list #'+currentID).prop('checked',false);
              $('#autocomplete-answers #'+currentID).prop('checked',false);
              $('#filters #'+currentID).prop('checked',false);
            }
      }

      //used for google maps api, necessary to clear map pins
      function clearMarkers(){
          for(var i=0;i<markers.length;i++){
              markers[i].setMap(null);
          }
        markers=[];
      }

      //shows all birds on map again
      function clearFilters(){
          clearMarkers();
          currentBirdSightings=[];
          Display.birdSightings(birdSightings);
      }

      //just adds html to filter list and adds listeners
      function addBirdsToFilterDisplay(item){
            $( "#filter-list #filters" ).append(filterListTemplate(item));
            $('.filter-list-check input').on('change',filterBirdListener);
            $('.filter-list-x button').on('click',removeFilter);
      }

      //puts birds onto the autocomplete list and adds listeners
      function fillAutoComplete(item){
          $('#autocomplete-answers').append(autocompListTemplate(item));
            $('.filter-list-check input').on('change',filterBirdListener);
      }

      //the html that shows up in the list of filters
      //has the x to close the filter
      function filterListTemplate(name){
          return "<div class='input-group'><span class='input-group-addon filter-list-check'><input id='"+nameToID(name)+"' data-name='"+name+"' type='checkbox'></span><span class='input-group-addon filter-list-species'>"+name+"</span><span class='input-group-btn filter-list-x'><button class='btn btn-default' id='"+nameToID(name)+"' type='button'><span class='glyphicon glyphicon-remove'></span></button></span></div>";
      }

      //hi everyone...SORRY THIS CODE IS SO UGLY...
      //has the class 'autocomplete-removable' on first div
      function autocompListTemplate(name){
          return "<div class='input-group autocomplete-removable'><span class='input-group-addon filter-list-check'><input id='"+nameToID(name)+"' data-name='"+name+"' type='checkbox'></span><span class='input-group-addon filter-list-species'>"+name+"</span><span class='input-group-addon filter-list-o'><span class='glyphicon glyphicon-remove'></span></span></div>";
      }

      //returns a version of the name with '-' intsead of ' '.
      //ex: Northern Cardinal --> Northern-Cardinal
      function nameToID(name){
          return name.replace(' ','-');
      }

      //html that shows up in list of birds
      //no x to close the filter, doesn't respond to any autocomplete stuff
      function birdListTemplate(name){
          var temp= "<div class='input-group'>"+
                "    <span class='input-group-addon filter-list-check'>"+
                "      <input id='"+nameToID(name)+"' data-name='"+name+"' type='checkbox'>"+
                "    </span>"+
                "    <span class='input-group-addon filter-list-species'>"+name+"</span>"+
                "    <span class='input-group-addon filter-list-o'>"+
                "        <span class='glyphicon glyphicon-remove'></span>"+
                "    </span>"+
                "  </div>";
          return temp;
      }

    $.getJSON('smallbirds.json', function(json) {
      birdSightings = Birdmap.processBirds(json);
      // Find all birds that are on the screen
      // display sightings
      Display.init();
      Display.birdSightings(birdSightings);
      var listOfAllBirds = Birdmap.getBirdSpecies(birdSightings);
      for(var i = 0; i < listOfAllBirds.length; i++){
          $('#entire-list').append(birdListTemplate(listOfAllBirds[i].commonName));
          birdsOnMap.push(listOfAllBirds[i].commonName);
      }
      $('.filter-list-check input').on('change',filterBirdListener);
    })

    // Make login overlay
    // $("#login-logout").overlay({
    //   closeOnClick: true,
    //   mask: {
    //     color: '#555555',
    //     loadSpeed: 100,
    //     opacity: 0.5
    //   },
    // });
    $("#login-form").overlay({
      closeOnClick: true,
      mask: {
        color: '#555555',
        loadSpeed: 100,
        opacity: 0.5
      },
      load: false,
    })

    $("#login-logout").click(function() {
      $("#login-form").data("overlay").load();
    })

    // upon submitting a login, set username
    // Oh boy, form validation!
    $("#login-form").submit(function(e) {
      e.preventDefault();
      if ($("username-entry").val() === "") {
      } else {
        username = $("#username-entry").val();
        $("#username-entry").val("");
        $("#login-form").data("overlay").close();
        // Lol unvalidated text
        $("#login-logout").text(username);
      }
    })


    //Create an overlay that must be programatically opened and closed
    $("#add-bird-form").overlay({
      top: "10%",
      closeOnClick: true,
      mask: {
        color: '#555555',
        loadSpeed: 100,
        opacity: 0.5
      },
      load: false,
    })

    // When you click the add-bird button, first check if user
    // is logged in, then make overlay
    // Problem: can only open overlay once?
    // What if you remove the overlay?

    // Add a tooltip
    // $("#add-bird").tooltip();

    // Desired behavior: when click button, check for username
    // if no username, prompt tooltip
    // If yes username, open overlay
    $("#add-bird").click(function() {
      if (!username) {
        $("#login-form").data("overlay").load();
      } else {
        // open overlay
        $("#add-bird-form").data("overlay").load();
      }
    })

    $("#add-bird-form").submit(function() {
      // Do some preprocessing of the data
      // date and time are string values
      var date = new Date(Date.parse($("#sighting-date").val()))
      var time = $("#sighting-time").val()
      // Parse the string, should have format 12:00 PM
      // Wow, this is annoying
      time = time.split(/[\s:]/)
      var hour = parseInt(time[0])
      var min = parseInt(time[1])
      if (time[2] == "PM") {
        hour += 12
      }
      date.setHours(hour)
      date.setMinutes(min)
      console.log(date)
      console.log(time)
      // Get the form values
      var newSighting = {
        commonName: $("#common-name").val(),
        speciesName: $("#species-name").val(),
        comment: $("#sighting-comments").val(),
      }
    })

    // function closeOverlay() {
    //   $("#add-bird-form").data("overlay").close();
    // }

    // Prevent clicking forms from refreshing page
    $("form").submit(function(e) {
      e.preventDefault();
    })

    // Add a date picker to add bird form
    $("#sighting-date").datepicker({
      maxDate: new Date(),
      dateFormat: "MM d, yy",
    });

    //Add a time picker to add bird form
    $("#sighting-time").timepicker({
      minuteStep: 30,
      showInputs: false,
      disableFocus: true,
    })
  });
  </script>
  <script id="bird-info-popup-template" type="text/x-handlebars-template">
  <div class="bird-popup">
      <div class="row">
          <div class="col-md-3">
                <img src="images/northern_cardinal_stephen_a_wolfe.jpg" alt="image of {{commonName}}" class="bird-image"><br></div>
          <div class="col-md-9">
              <dl class="dl-horizontal bird-info">
                  <dt>Common Name:</dt> <dd>{{commonName}}</dd>
                  <dt>Species Name:</dt> <dd>{{speciesName}}</dd>
                  <dt>Date:</dt> <dd>{{date}}</dd>
                  <dt>User:</dt> <dd>{{userSpotted}}</dd>
                  <dt>Comment:</dt> <dd>{{comment}}</dd>
              </dl>
          </div>
      </div>
  </div>
  </script>

</head>
 <!-- Col should add up to 12 -->
<body></body>
  <div class="container-fluid">
    <div class="row">
    <!-- header -->
    <div class="row" id="filter-options">
          <div class="col-md-4">
            <big><big><big>
              <a href="index.html">birdOcular</a>
              <span class="glyphicon glyphicon-eye-open"></span>
                &nbsp;
              <span id="username"></span>
              <a id="login-logout" rel="#login-form">Login</a>
            </big></big></big>
          </div>
          <div class="col-md-2">
            <button id="add-bird" rel="#add-bird-form" type="button" class="btn btn-default">Add bird</button>
          </div>
          <div class="col-md-2">
            <select name="" id="time-select" class="form-control">
              <option value="all">All</option>
              <option value="today">Today</option>
              <option value="week">This week</option>
              <option value="month">This month</option>
            </select>
          </div>
          <div class="col-md-4">
            <div class="input-group">
              <input id="input_bar" type="text" class="form-control" placeholder="Filter by species or location">
              <span class="input-group-btn">
                <button class="btn btn-default " type="button">Filter</button>
              </span>
            </div><!-- /input-group -->
          </div>
      </div>

      <!--list of filters, overlayed on map (for now) -->
      <div class="row" id="filter-list-row" style="position:absolute;">
          <div class="col-md-4"></div>
          <div class="col-md-4"></div>
          <div class="col-md-4" id="filter-list" style="z-index:1">
              <div id="autocomplete-answers"></div>

              <div id="filtered-div" class="row">&nbsp; Filtered:<div id="filters"></div></div>
              <div class="row">&nbsp; All Birds on Map:<div id="entire-list"></div>
              </div>
        </div>
      </div>

      <!--map-->
      <div class="row" style="z-index:0;" id="map">
        <!-- Nest some columns -->
        <div id="map-canvas"></div>
      </div>
  </div>

  <!-- Separate container for add bird overlay -->
  <div class="container" >
    <div id="add-bird-form-bg">
      <form id="add-bird-form" class="form-horizontal col-md-offset-1 col-md-9" role="form" action="">
      <div class="row">
        <h3>Add new bird</h3>
        <div id="close-add-bird" class="close glyphicon glyphicon-remove"></div>
      </div>
        <div class="form-group col-md-5">
          <label for="bird-pic">Insert picture</label>
          <input type="file" id="bird-pic" class="form-control">
        </div>
        <div class="col-md-7">
          <div class="form-group">
            <label class="col-md-3" for="common-name">Common name</label>
            <div class="col-md-9">
              <input type="text" placeholder="Ex. Northern Cardinal" class="form-control" id="common-name" required>
            </div>
          </div>
          <div class="form-group">
            <label class="col-md-3" for="species-name">Species name</label>
            <div class="col-md-9">
              <input type="text" placeholder="Ex. Cardinalis cardinalis" class="form-control" id="species-name" required>
            </div>
          </div>
          <div class="form-group">
            <label class="col-md-3" for="sighting-date">Date</label>
            <div class="col-md-9">
              <input type="text" class="form-control" id="sighting-date" required>
            </div>
          </div>
          <div class="form-group">
            <label class="col-md-3" for="sighting-time">Time</label>
            <div class="col-md-9">
              <input type="text" id="sighting-time" class="input-small form-control" required>
            </div>
          </div>
          <div class="form-group">
            <label class="col-md-3" for="sighting-location">Location</label>
            <div class="col-md-9">
              <input type="text" id="sighting-location" class="form-control" placeholder="Ex. 77 Massachusetts Ave, Cambridge MA" required>
            </div>
          </div>
          <div class="form-group">
            <label class="col-md-3" for="sighting-comments">Comments</label>
            <div class="col-md-9">
              <textarea id="sighting-comments" class="form-control" rows="4" placeholder="Ex. This bird is really red!"></textarea>
            </div>
          </div>
          <button id="add-bird-submit" type="submit" class="btn btn-default col-md-12 close">Add bird</button>
        </div>
      </form>
    </div>
  </div>

  <div class="container">
    <div id="login-form-bg">
      <form id="login-form" class="form-horizontal col-md-offset-1 col-md-6" role="form" action="">
      <div class="row">
        <h3>Sign up to add birds</h3>
        <div id="close-add-bird" class="close glyphicon glyphicon-remove"></div>
      </div>
        <div class="form-group">
          <label class="col-md-3" for="username-entry">Username</label>
          <div class="col-md-9">
            <input class="form-control" id="username-entry" type="text" placeholder="Ex. BirdWatcherPerson" required>
          </div>
        </div>
        <button id="login-submit" class="btn btn-default col-md-12" type="submit">Sign up</button>
      </form>
    </div>
  </div>
</body>
</html>
